#!/bin/bash

echo "Running pre-commit hooks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# Get list of staged Ruby files
STAGED_RUBY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rb$')

# Get list of staged TypeScript/JavaScript files in frontend
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^frontend/.*\.(ts|tsx|js|jsx)$')

# Run RuboCop on staged Ruby files
if [ -n "$STAGED_RUBY_FILES" ]; then
  if command -v bundle &> /dev/null; then
    echo "Running RuboCop on staged Ruby files..."
    echo "$STAGED_RUBY_FILES" | xargs bundle exec rubocop --force-exclusion
    if [ $? -ne 0 ]; then
      echo -e "${RED}RuboCop failed. Please fix the issues above.${NC}"
      FAILED=1
    else
      echo -e "${GREEN}RuboCop passed!${NC}"
    fi
  else
    echo -e "${YELLOW}Warning: bundle not found, skipping RuboCop${NC}"
  fi
fi

# Run ESLint on staged TypeScript files
if [ -n "$STAGED_TS_FILES" ]; then
  # Try to find npm - check common locations
  if command -v npm &> /dev/null; then
    NPM_CMD="npm"
  elif [ -f "$HOME/.nvm/nvm.sh" ]; then
    # Load nvm if available
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    NPM_CMD="npm"
  elif [ -x "/usr/local/bin/npm" ]; then
    NPM_CMD="/usr/local/bin/npm"
  elif [ -x "/opt/homebrew/bin/npm" ]; then
    NPM_CMD="/opt/homebrew/bin/npm"
  else
    NPM_CMD=""
  fi

  if [ -n "$NPM_CMD" ]; then
    echo "Running ESLint on staged frontend files..."
    cd frontend
    # Convert full paths to relative paths from frontend directory
    RELATIVE_FILES=$(echo "$STAGED_TS_FILES" | sed 's|^frontend/||')
    echo "$RELATIVE_FILES" | xargs $NPM_CMD run lint -- --max-warnings=0
    if [ $? -ne 0 ]; then
      echo -e "${RED}ESLint failed. Please fix the issues above.${NC}"
      FAILED=1
    else
      echo -e "${GREEN}ESLint passed!${NC}"
    fi
    cd ..
  else
    echo -e "${YELLOW}Warning: npm not found, skipping ESLint${NC}"
    echo -e "${YELLOW}To enable ESLint checks, ensure npm is in your PATH${NC}"
  fi
fi

# Run RSpec tests
if [ -n "$STAGED_RUBY_FILES" ] || [ -d "spec" ]; then
  if command -v bundle &> /dev/null; then
    echo "Running RSpec tests..."
    bundle exec rspec --format progress
    if [ $? -ne 0 ]; then
      echo -e "${RED}RSpec tests failed. Please fix the failing tests.${NC}"
      FAILED=1
    else
      echo -e "${GREEN}RSpec tests passed!${NC}"
    fi
  fi
fi

# Run Jest tests with coverage enforcement
if [ -n "$STAGED_TS_FILES" ] || [ -d "frontend/src" ]; then
  if [ -n "$NPM_CMD" ]; then
    echo "Running Jest tests with coverage..."
    cd frontend
    $NPM_CMD test -- --coverage --watchAll=false --passWithNoTests
    if [ $? -ne 0 ]; then
      echo -e "${RED}Jest tests failed or coverage thresholds not met.${NC}"
      echo -e "${RED}Coverage thresholds: branches 85%, functions 95%, lines 96%, statements 96%${NC}"
      FAILED=1
    else
      echo -e "${GREEN}Jest tests passed with coverage thresholds met!${NC}"
    fi
    cd ..
  fi
fi

if [ $FAILED -ne 0 ]; then
  echo -e "${RED}Pre-commit hooks failed. Commit aborted.${NC}"
  exit 1
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
